# APSIM SQLite to JSON Converter

A specialized tool for converting SQLite databases generated by APSIM (Agricultural Production Systems sIMulator) or APSIM-derived pipelines into clean, deterministic, LLM-readable JSON format while preserving scientific meaning.

## Features

- **Complete table enumeration**: Automatically discovers and exports all tables in the database
- **APSIM-aware processing**: Special handling for Daily, Report, _Messages, and metadata tables
- **Data cleaning**: Converts dates to ISO format, handles APSIM placeholder dates, and preserves data types
- **LLM-ready output**: Structured JSON format optimized for AI reasoning and analysis
- **Data dictionary**: Auto-generates APSIM-aware column descriptions
- **Year-grouped exports**: For large Daily tables (>5000 rows), creates additional year-grouped files

## Installation

No external dependencies required! Uses only Python standard library.

```bash
# Python 3.7+ required
python --version
```

## Usage

### Basic Usage

```bash
python apsim_sqlite_to_json.py <database.db>
```

This will:
1. Read the SQLite database
2. Export all tables to JSON files in the **same folder** as the input file
3. Generate a data dictionary

### Batch Processing

Process all `.db` files in the default input directory:
```bash
python apsim_sqlite_to_json.py --batch
```

Default input directory: `C:\Users\ibian\Desktop\ClimAdapt\Anameka\APSIM files`

Process all `.db` files in a custom directory:
```bash
python apsim_sqlite_to_json.py --batch --input-dir "C:\path\to\databases"
```

### Specify Output Directory

```bash
python apsim_sqlite_to_json.py simulation.db -o output_directory
```

## Output Structure

For each table in the database, a JSON file is created with the following structure:

```json
{
  "table": "Daily",
  "row_count": 3650,
  "columns": {
    "Year": "integer",
    "Day": "integer",
    "Date": "text",
    "Rain": "float",
    "Yield": "float"
  },
  "rows": [
    {
      "Year": 2012,
      "Day": 1,
      "Date": "2012-01-01",
      "Rain": 0.0,
      "Yield": null
    }
  ]
}
```

### Special Files

- **Daily_by_year.json**: Created automatically for Daily tables with >5000 rows, grouped by year
- **data_dictionary.json**: Contains APSIM-aware descriptions for all columns in all tables

## APSIM-Specific Handling

### Daily Tables
- Preserves one row per simulated day
- Converts all dates to ISO format (YYYY-MM-DD)
- Replaces APSIM placeholder dates (0001-01-01) with `null`
- Preserves all stress indices, phenology counters, water balance variables, and weather variables
- Generates year-grouped file if row count > 5000

### Report Tables
- Preserves one row per simulation × year × zone × cultivar
- Ensures sowing, flowering, and maturity dates are in ISO format
- Preserves crop survival flags and phenological timing variables

### _Messages Tables
- Preserves message text verbatim
- Preserves severity/type fields if present
- Critical for downstream interpretation by analysts and LLMs

### Metadata Tables
- Exports _Simulations, _Checkpoints, _InitialConditions, _Units tables
- Preserves all identifiers exactly as stored
- _Units exported verbatim for unit resolution downstream

## Data Cleaning Rules

Applied to all tables:

- **Dates**: Converted to ISO format (YYYY-MM-DD)
- **Invalid dates**: APSIM placeholder dates (0001-01-01) → `null`
- **Empty strings**: Converted to `null`
- **Type preservation**: Integers, floats, booleans preserved as-is
- **No modifications**: Columns not renamed, rows not dropped, no aggregation

## Data Dictionary

The `data_dictionary.json` file provides APSIM-aware descriptions for all columns:

```json
{
  "Daily": {
    "FloweringDaysAfterSowing": {
      "type": "integer",
      "description": "Number of days from sowing to flowering as simulated by APSIM phenology"
    }
  }
}
```

## Use Cases

This converter is designed for:

- **LLM reasoning**: Feed APSIM outputs directly to AI systems
- **Climate risk analysis**: Analyze crop responses to climate variability
- **Phenology diagnostics**: Understand crop development timing
- **Yield variability interpretation**: Compare scenarios across years, zones, cultivars
- **Adaptation stress attribution**: Diagnose stress events and model behavior

## Example Workflow

```bash
# Convert single APSIM database
python apsim_sqlite_to_json.py my_simulation.db

# Batch process all databases in default directory
python apsim_sqlite_to_json.py --batch

# Output files are written to the same folder as input:
# C:\Users\ibian\Desktop\ClimAdapt\Anameka\APSIM files\
#   ├── my_simulation.db
#   ├── Daily.json
#   ├── Daily_by_year.json (if >5000 rows)
#   ├── Report.json
#   ├── _Messages.json
#   ├── _Simulations.json
#   ├── _Checkpoints.json
#   └── data_dictionary.json
```

## Technical Details

- **Encoding**: UTF-8
- **JSON format**: Pretty-printed, deterministic
- **Date handling**: Automatic detection and conversion to ISO format
- **Null handling**: Empty strings and invalid dates become `null`
- **Type inference**: Preserves SQLite types (integer, float, text, blob)

## License

This tool is designed for scientific and research use with APSIM simulation outputs.
